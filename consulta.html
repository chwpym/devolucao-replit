<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar Devoluções - Sistema de Controle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-tools me-2"></i>
                Sistema de Controle de Retorno de Peças
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="cadastroDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-plus-circle me-1"></i>Cadastrar
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="cadastro.html">
                                <i class="fas fa-undo me-2"></i>Devolução
                            </a></li>
                            <li><a class="dropdown-item" href="cadastro-pessoas.html">
                                <i class="fas fa-user me-2"></i>Cliente/Mecânico
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="consulta.html">
                            <i class="fas fa-search me-1"></i>Consultar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="relatorio.html">
                            <i class="fas fa-chart-bar me-1"></i>Relatórios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="backup.html">
                            <i class="fas fa-download me-1"></i>Backup
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="page-header mb-4">
                    <h1 class="display-5">Consultar Devoluções</h1>
                    <p class="text-muted">Busque e filtre devoluções registradas</p>
                </div>
            </div>
        </div>

        <!-- Search Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>
                            Filtros de Busca
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="filterCodigoPeca" class="form-label">Código da Peça</label>
                                    <input type="text" class="form-control" id="filterCodigoPeca" placeholder="Digite o código da peça">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="filterCliente" class="form-label">Cliente</label>
                                    <input type="text" class="form-control" id="filterCliente" placeholder="Digite o nome do cliente">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="filterMecanico" class="form-label">Mecânico</label>
                                    <input type="text" class="form-control" id="filterMecanico" placeholder="Digite o nome do mecânico">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="filterRequisicaoVenda" class="form-label">Requisição de Venda</label>
                                    <input type="text" class="form-control" id="filterRequisicaoVenda" placeholder="Digite o código da venda">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="filterAcaoRequisicao" class="form-label">Ação na Requisição</label>
                                    <select class="form-select" id="filterAcaoRequisicao">
                                        <option value="">Todas as ações</option>
                                        <option value="Alterada">Alterada</option>
                                        <option value="Excluída">Excluída</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="filterDescricaoPeca" class="form-label">Descrição da Peça</label>
                                    <input type="text" class="form-control" id="filterDescricaoPeca" placeholder="Digite a descrição da peça">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="filterDataVendaInicio" class="form-label">Data Venda (Início)</label>
                                    <input type="date" class="form-control" id="filterDataVendaInicio">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="filterDataVendaFim" class="form-label">Data Venda (Fim)</label>
                                    <input type="date" class="form-control" id="filterDataVendaFim">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="filterDataDevolucaoInicio" class="form-label">Data Devolução (Início)</label>
                                    <input type="date" class="form-control" id="filterDataDevolucaoInicio">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="filterDataDevolucaoFim" class="form-label">Data Devolução (Fim)</label>
                                    <input type="date" class="form-control" id="filterDataDevolucaoFim">
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-search me-1"></i>Buscar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Limpar Filtros
                                </button>
                                <button type="button" class="btn btn-success ms-auto" onclick="exportToCSV()">
                                    <i class="fas fa-download me-1"></i>Exportar CSV
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Resultados da Busca
                        </h5>
                        <span class="badge bg-primary" id="resultCount">0 resultados</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('codigo_peca')">
                                                Código <i class="fas fa-sort" id="sort-codigo_peca"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('descricao_peca')">
                                                Descrição <i class="fas fa-sort" id="sort-descricao_peca"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('quantidade_devolvida')">
                                                Quantidade <i class="fas fa-sort" id="sort-quantidade_devolvida"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('cliente')">
                                                Cliente <i class="fas fa-sort" id="sort-cliente"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('mecanico')">
                                                Mecânico <i class="fas fa-sort" id="sort-mecanico"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('requisicao_venda')">
                                                Req. Venda <i class="fas fa-sort" id="sort-requisicao_venda"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('acao_requisicao')">
                                                Ação <i class="fas fa-sort" id="sort-acao_requisicao"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('data_venda')">
                                                Data Venda <i class="fas fa-sort" id="sort-data_venda"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortSearchTable('data_devolucao')">
                                                Data Devolução <i class="fas fa-sort" id="sort-data_devolucao"></i>
                                            </button>
                                        </th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted py-4">
                                            <i class="fas fa-search fa-2x mb-2 d-block"></i>
                                            Use os filtros acima para buscar devoluções
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>
                        Detalhes da Devolução
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        Confirmar Exclusão
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir esta devolução?</p>
                    <p class="text-muted small">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i>Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-center text-muted">
                    <p class="mb-0">Sistema de Controle de Retorno de Peças &copy; 2024</p>
                </div>
                <div id="syncStatus" class="text-muted small"></div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/database.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/init.js"></script>
    <script>
        let currentResults = [];
        let deleteItemId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize database
                await initDatabase();
                
                // Load all devolutions initially
                await loadAllDevolutions();
                
                // Initialize backup reminder
                await safeInitBackupReminder();
            } catch (error) {
                console.error('Error initializing search:', error);
                showAlert('Erro ao inicializar busca: ' + error.message, 'danger');
            }
        });

        // Sorting variables for search results
        let searchSortColumn = 'data_devolucao';
        let searchSortDirection = 'desc';

        async function loadAllDevolutions() {
            try {
                const db = await getDatabase();
                const tx = db.transaction('devolucoes', 'readonly');
                const store = tx.objectStore('devolucoes');
                currentResults = await store.getAll();
                
                displayResults(currentResults);
            } catch (error) {
                console.error('Error loading devolutions:', error);
                showAlert('Erro ao carregar devoluções: ' + error.message, 'danger');
            }
        }

        async function applyFilters() {
            try {
                const db = await getDatabase();
                const tx = db.transaction('devolucoes', 'readonly');
                const store = tx.objectStore('devolucoes');
                const allDevolutions = await store.getAll();

                const filters = {
                    codigoPeca: document.getElementById('filterCodigoPeca').value.toLowerCase(),
                    cliente: document.getElementById('filterCliente').value.toLowerCase(),
                    mecanico: document.getElementById('filterMecanico').value.toLowerCase(),
                    requisicaoVenda: document.getElementById('filterRequisicaoVenda').value.toLowerCase(),
                    acaoRequisicao: document.getElementById('filterAcaoRequisicao').value,
                    descricaoPeca: document.getElementById('filterDescricaoPeca').value.toLowerCase(),
                    dataVendaInicio: document.getElementById('filterDataVendaInicio').value,
                    dataVendaFim: document.getElementById('filterDataVendaFim').value,
                    dataDevolucaoInicio: document.getElementById('filterDataDevolucaoInicio').value,
                    dataDevolucaoFim: document.getElementById('filterDataDevolucaoFim').value
                };

                currentResults = allDevolutions.filter(dev => {
                    // Text filters
                    if (filters.codigoPeca && !dev.codigo_peca.toLowerCase().includes(filters.codigoPeca)) return false;
                    if (filters.cliente && !dev.cliente.toLowerCase().includes(filters.cliente)) return false;
                    if (filters.mecanico && !dev.mecanico.toLowerCase().includes(filters.mecanico)) return false;
                    if (filters.requisicaoVenda && !dev.requisicao_venda.toLowerCase().includes(filters.requisicaoVenda)) return false;
                    if (filters.descricaoPeca && !dev.descricao_peca.toLowerCase().includes(filters.descricaoPeca)) return false;
                    
                    // Dropdown filter
                    if (filters.acaoRequisicao && dev.acao_requisicao !== filters.acaoRequisicao) return false;
                    
                    // Date filters
                    if (filters.dataVendaInicio && dev.data_venda < filters.dataVendaInicio) return false;
                    if (filters.dataVendaFim && dev.data_venda > filters.dataVendaFim) return false;
                    if (filters.dataDevolucaoInicio && dev.data_devolucao < filters.dataDevolucaoInicio) return false;
                    if (filters.dataDevolucaoFim && dev.data_devolucao > filters.dataDevolucaoFim) return false;
                    
                    return true;
                });

                displayResults(currentResults);
            } catch (error) {
                console.error('Error applying filters:', error);
                showAlert('Erro ao aplicar filtros: ' + error.message, 'danger');
            }
        }

        function clearFilters() {
            document.getElementById('searchForm').reset();
            loadAllDevolutions();
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsTable');
            const resultCount = document.getElementById('resultCount');
            
            resultCount.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''}`;

            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2 d-block"></i>
                            Nenhuma devolução encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = results.map(dev => `
                <tr>
                    <td>${dev.codigo_peca}</td>
                    <td>${dev.descricao_peca}</td>
                    <td>
                        <span class="badge bg-primary">${dev.quantidade_devolvida}</span>
                    </td>
                    <td>${dev.cliente}</td>
                    <td>${dev.mecanico}</td>
                    <td>${dev.requisicao_venda}</td>
                    <td>
                        <span class="badge ${dev.acao_requisicao === 'Alterada' ? 'bg-warning' : 'bg-danger'} text-dark">
                            ${dev.acao_requisicao}
                        </span>
                    </td>
                    <td>${formatDate(dev.data_venda)}</td>
                    <td>${formatDate(dev.data_devolucao)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" onclick="viewDetails(${dev.id})" title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="editDevolution(${dev.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="confirmDelete(${dev.id})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function viewDetails(id) {
            const devolution = currentResults.find(dev => dev.id === id);
            if (!devolution) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <strong>Código da Peça:</strong><br>
                        ${devolution.codigo_peca}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Descrição da Peça:</strong><br>
                        ${devolution.descricao_peca}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Quantidade Devolvida:</strong><br>
                        <span class="badge bg-primary">${devolution.quantidade_devolvida}</span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Cliente:</strong><br>
                        ${devolution.cliente}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Mecânico:</strong><br>
                        ${devolution.mecanico}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Requisição de Venda:</strong><br>
                        ${devolution.requisicao_venda}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Ação na Requisição:</strong><br>
                        <span class="badge ${devolution.acao_requisicao === 'Alterada' ? 'bg-warning' : 'bg-danger'} text-dark">
                            ${devolution.acao_requisicao}
                        </span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Data da Venda:</strong><br>
                        ${formatDate(devolution.data_venda)}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Data da Devolução:</strong><br>
                        ${formatDate(devolution.data_devolucao)}
                    </div>
                    ${devolution.observacao ? `
                    <div class="col-12 mb-3">
                        <strong>Observação:</strong><br>
                        <div class="bg-light p-2 rounded">${devolution.observacao}</div>
                    </div>
                    ` : ''}
                </div>
            `;

            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }

        function confirmDelete(id) {
            deleteItemId = id;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (!deleteItemId) return;

            try {
                const db = await getDatabase();
                const tx = db.transaction('devolucoes', 'readwrite');
                const store = tx.objectStore('devolucoes');
                await store.delete(deleteItemId);

                // Hide modal
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                
                // Refresh results
                await applyFilters();
                
                showAlert('Devolução excluída com sucesso!', 'success');
                deleteItemId = null;
            } catch (error) {
                console.error('Error deleting devolution:', error);
                showAlert('Erro ao excluir devolução: ' + error.message, 'danger');
            }
        });

        function exportToCSV() {
            if (currentResults.length === 0) {
                showAlert('Nenhum dado para exportar', 'warning');
                return;
            }

            const headers = [
                'Código da Peça',
                'Descrição da Peça',
                'Quantidade Devolvida',
                'Cliente',
                'Mecânico',
                'Requisição de Venda',
                'Ação na Requisição',
                'Data da Venda',
                'Data da Devolução',
                'Observação'
            ];

            const csvContent = [
                headers.join(','),
                ...currentResults.map(dev => [
                    `"${dev.codigo_peca}"`,
                    `"${dev.descricao_peca}"`,
                    dev.quantidade_devolvida,
                    `"${dev.cliente}"`,
                    `"${dev.mecanico}"`,
                    `"${dev.requisicao_venda}"`,
                    `"${dev.acao_requisicao}"`,
                    dev.data_venda,
                    dev.data_devolucao,
                    `"${dev.observacao || ''}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `devolucoes_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('Arquivo CSV exportado com sucesso!', 'success');
        }

        function editDevolution(id) {
            // Redirect to cadastro page with edit parameter
            window.location.href = `cadastro.html?edit=${id}`;
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Create a temporary container at the top of the page
            const alertContainer = document.createElement('div');
            alertContainer.innerHTML = alertHtml;
            alertContainer.style.position = 'fixed';
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '9999';
            alertContainer.style.minWidth = '300px';
            
            document.body.appendChild(alertContainer);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.parentNode.removeChild(alertContainer);
                }
            }, 5000);
        }

        // Sort search results table
        function sortSearchTable(column) {
            if (searchSortColumn === column) {
                searchSortDirection = searchSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                searchSortColumn = column;
                searchSortDirection = 'asc';
            }

            // Update sort icons
            document.querySelectorAll('[id^="sort-"]').forEach(icon => {
                icon.className = 'fas fa-sort';
            });

            const currentIcon = document.getElementById(`sort-${column}`);
            if (currentIcon) {
                currentIcon.className = `fas fa-sort-${searchSortDirection === 'asc' ? 'up' : 'down'}`;
            }

            // Sort the current results
            currentResults.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                // Handle date columns
                if (column.includes('data')) {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (column === 'quantidade_devolvida') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (searchSortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return bVal < aVal ? -1 : bVal > aVal ? 1 : 0;
                }
            });

            // Redisplay sorted results
            displayResults(currentResults);
        }
    </script>
</body>
</html>

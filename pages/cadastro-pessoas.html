<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Pessoa - Sistema de Controle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-tools me-2"></i>
                Sistema de Controle
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- Populated by menu.js -->
            </div>
        </div>
    </nav>

    <!-- Sidebar for mobile -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-tools me-2"></i>Menu</h4>
            <button class="sidebar-close" onclick="closeSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-menu">
            <!-- Populated by menu.js -->
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="page-header mb-4">
                    <h1 class="display-5">Cadastrar Cliente/Mecânico</h1>
                    <p class="text-muted">Registre uma nova pessoa que pode atuar como cliente ou mecânico</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Form Column -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user-plus me-2"></i>
                            Formulário de Cadastro
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Alert container -->
                        <div id="alertContainer"></div>

                        <form id="personForm" novalidate>
                            <div class="row">
                                <!-- Basic Information -->
                                <div class="col-md-3 mb-3">
                                    <label for="codigo" class="form-label">Código</label>
                                    <input type="text" class="form-control" id="codigo" name="codigo" readonly style="background-color: #f8f9fa;">
                                    <small class="text-muted">Gerado automaticamente</small>
                                </div>
                                
                                <div class="col-md-5 mb-3">
                                    <label for="nome" class="form-label">
                                        Nome Completo <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="nome" name="nome" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe o nome completo.
                                    </div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="tipo" class="form-label">
                                        Tipo <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="tipo" name="tipo" required>
                                        <option value="">Selecione o tipo</option>
                                        <option value="Cliente">Apenas Cliente</option>
                                        <option value="Mecânico">Apenas Mecânico</option>
                                        <option value="Ambos">Cliente e Mecânico</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione o tipo da pessoa.
                                    </div>
                                </div>

                                <!-- Contact Information -->
                                <div class="col-md-6 mb-3">
                                    <label for="telefone" class="form-label">Telefone</label>
                                    <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="(11) 99999-9999">
                                    <div class="invalid-feedback">
                                        Formato inválido de telefone.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input type="email" class="form-control" id="email" name="email" placeholder="exemplo@email.com">
                                    <div class="invalid-feedback">
                                        Formato inválido de e-mail.
                                    </div>
                                </div>

                                <!-- Document -->
                                <div class="col-md-6 mb-3">
                                    <label for="documento" class="form-label">CPF/CNPJ</label>
                                    <input type="text" class="form-control" id="documento" name="documento" placeholder="000.000.000-00">
                                    <div class="invalid-feedback">
                                        Documento inválido.
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="Ativo">Ativo</option>
                                        <option value="Inativo">Inativo</option>
                                    </select>
                                </div>

                                <!-- Address -->
                                <div class="col-12 mb-3">
                                    <label for="endereco" class="form-label">Endereço</label>
                                    <textarea class="form-control" id="endereco" name="endereco" rows="2" placeholder="Rua, número, bairro, cidade, CEP..."></textarea>
                                </div>

                                <!-- Notes -->
                                <div class="col-12 mb-3">
                                    <label for="observacoes" class="form-label">Observações</label>
                                    <textarea class="form-control" id="observacoes" name="observacoes" rows="3" placeholder="Informações adicionais..."></textarea>
                                </div>
                            </div>

                            <div class="d-flex gap-2 justify-content-end">
                                <button type="button" class="btn btn-secondary" onclick="resetPersonForm()">
                                    <i class="fas fa-times me-1"></i>Limpar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Salvar Pessoa
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Info Column -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Informações
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">Sobre os Tipos:</h6>
                            <ul class="mb-0 small">
                                <li><strong>Apenas Cliente:</strong> Pessoa aparecerá apenas na lista de clientes</li>
                                <li><strong>Apenas Mecânico:</strong> Pessoa aparecerá apenas na lista de mecânicos</li>
                                <li><strong>Cliente e Mecânico:</strong> Pessoa pode atuar nas duas funções</li>
                            </ul>
                        </div>

                        <div class="alert alert-warning">
                            <h6 class="alert-heading">Dica:</h6>
                            <p class="mb-0 small">Na maioria dos casos, a mesma pessoa atua como cliente e mecânico. Selecione "Cliente e Mecânico" para facilitar o cadastro de devoluções.</p>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-users me-2"></i>
                                    Pessoas Recentes
                                </h6>
                            </div>
                            <div class="card-body" id="recentPeople">
                                <p class="text-muted small">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- People List Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Pessoas Cadastradas
                        </h5>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="showPeopleConsultation()">
                            <i class="fas fa-search me-1"></i>Consultar
                        </button>
                    </div>
                    <div class="card-body" id="peopleConsultationSection" style="display: none;">
                        <div class="d-flex gap-2 mb-3">
                            <select class="form-select form-select-sm" id="filterType" style="width: auto;">
                                <option value="">Todos os tipos</option>
                                <option value="Cliente">Clientes</option>
                                <option value="Mecânico">Mecânicos</option>
                                <option value="Ambos">Ambos</option>
                            </select>
                            <select class="form-select form-select-sm" id="filterStatus" style="width: auto;">
                                <option value="">Todos os status</option>
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortPeopleTable('nome')">
                                                Nome <i class="fas fa-sort" id="sort-nome"></i>
                                            </button>
                                        </th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortPeopleTable('tipo')">
                                                Tipo <i class="fas fa-sort" id="sort-tipo"></i>
                                            </button>
                                        </th>
                                        <th>Telefone</th>
                                        <th>Email</th>
                                        <th>
                                            <button class="btn btn-link p-0 text-decoration-none" onclick="sortPeopleTable('status')">
                                                Status <i class="fas fa-sort" id="sort-status"></i>
                                            </button>
                                        </th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="peopleTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Carregando pessoas...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Recent Additions -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            Cadastros Recentes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recentPeople">
                            <p class="text-muted small">Nenhuma pessoa cadastrada ainda.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-center text-muted">
                    <p class="mb-0">Sistema de Controle de Retorno de Peças &copy; 2024</p>
                </div>
                <div id="syncStatus" class="text-muted small"></div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <script src="../js/menu.js"></script>
    <script src="../js/database.js"></script>
    <script src="../js/pessoas.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/sync.js"></script>
    <script src="../js/init.js"></script>
    <script>
        // Sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.add('show');
            overlay.classList.add('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', async function() {
            if (window.populateMenu) {
                window.populateMenu('cadastros', '../');
            }
            try {
                // Initialize database
                await initDatabase();
                
                // Initialize people database
                await initPeopleDatabase();
                
                // Initialize form validation
                initPersonFormValidation();
                
                // Load recent people (with error handling)
                try {
                    await loadRecentPeople();
                } catch (loadError) {
                    console.warn('Could not load recent people on init:', loadError);
                }

                // Check if editing mode
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit');
                if (editId) {
                    await loadPersonForEdit(editId);
                }

                // Load people table
                await loadPeopleTable();

                // Add filter event listeners
                document.getElementById('filterType').addEventListener('change', filterPeopleTable);
                document.getElementById('filterStatus').addEventListener('change', filterPeopleTable);
                
                // Initialize backup reminder
                await safeInitBackupReminder();
            } catch (error) {
                console.error('Error initializing form:', error);
                showAlert('Erro ao inicializar formulário: ' + error.message, 'danger');
            }
        });

        function resetPersonForm() {
            const form = document.getElementById('personForm');
            form.reset();
            form.classList.remove('was-validated');
            
            // Set default status
            document.getElementById('status').value = 'Ativo';
            
            // Clear any alerts
            document.getElementById('alertContainer').innerHTML = '';
            
            // Reset page to creation mode
            document.querySelector('.page-header h1').textContent = 'Cadastrar Pessoa';
            document.querySelector('.page-header p').textContent = 'Adicione informações de clientes e mecânicos ao sistema';
            document.querySelector('.card-header h5').innerHTML = '<i class="fas fa-user-plus me-2"></i>Cadastrar Nova Pessoa';
            document.querySelector('#personForm button[type="submit"]').innerHTML = '<i class="fas fa-save me-1"></i>Salvar Pessoa';
            window.editingPersonId = null;
        }

        async function loadPersonForEdit(id) {
            try {
                const people = await getAllPeople();
                const person = people.find(p => p.id === parseInt(id));
                
                if (!person) {
                    showAlert('Pessoa não encontrada.', 'warning');
                    return;
                }

                // Update page title and form
                document.querySelector('.page-header h1').textContent = 'Editar Pessoa';
                document.querySelector('.page-header p').textContent = 'Edite os dados da pessoa selecionada';
                document.querySelector('.card-header h5').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Pessoa';
                document.querySelector('#personForm button[type="submit"]').innerHTML = '<i class="fas fa-save me-1"></i>Atualizar Pessoa';

                // Fill form with existing data
                document.getElementById('nome').value = person.nome || '';
                document.getElementById('tipo').value = person.tipo || '';
                document.getElementById('telefone').value = person.telefone || '';
                document.getElementById('email').value = person.email || '';
                document.getElementById('documento').value = person.documento || '';
                document.getElementById('status').value = person.status || 'Ativo';
                document.getElementById('endereco').value = person.endereco || '';
                document.getElementById('observacoes').value = person.observacoes || '';

                // Store edit ID for later use
                window.editingPersonId = parseInt(id);

                showAlert('Dados carregados para edição.', 'info');
            } catch (error) {
                console.error('Error loading person for edit:', error);
                showAlert('Erro ao carregar pessoa: ' + error.message, 'danger');
            }
        }

        // People table management variables
        let allPeople = [];
        let sortColumn = 'nome';
        let sortDirection = 'asc';

        // Load and display people table
        async function loadPeopleTable() {
            try {
                allPeople = await getAllPeople();
                // Sort by name initially
                allPeople.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'));
                displayPeopleTable(allPeople);
            } catch (error) {
                console.error('Error loading people table:', error);
                document.getElementById('peopleTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar pessoas</td></tr>';
            }
        }

        // Display people in table
        function displayPeopleTable(people) {
            const tbody = document.getElementById('peopleTableBody');
            
            if (people.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma pessoa encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = people.map(person => `
                <tr>
                    <td><strong>${person.nome}</strong></td>
                    <td>
                        <span class="badge bg-${getTypeBadgeColor(person.tipo)}">${person.tipo}</span>
                    </td>
                    <td>${person.telefone || '-'}</td>
                    <td>${person.email || '-'}</td>
                    <td>
                        <span class="badge bg-${person.status === 'Ativo' ? 'success' : 'secondary'}">${person.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editPerson(${person.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewPersonDetails(${person.id})" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Get badge color for person type
        function getTypeBadgeColor(tipo) {
            switch(tipo) {
                case 'Cliente': return 'primary';
                case 'Mecânico': return 'warning';
                case 'Ambos': return 'success';
                default: return 'secondary';
            }
        }

        // Sort people table
        function sortPeopleTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Update sort icons
            document.querySelectorAll('[id^="sort-"]').forEach(icon => {
                icon.className = 'fas fa-sort';
            });

            const currentIcon = document.getElementById(`sort-${column}`);
            currentIcon.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}`;

            // Sort the data
            const filteredPeople = getCurrentFilteredPeople();
            filteredPeople.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (sortDirection === 'asc') {
                    return aVal.localeCompare ? aVal.localeCompare(bVal, 'pt-BR') : aVal < bVal ? -1 : 1;
                } else {
                    return bVal.localeCompare ? bVal.localeCompare(aVal, 'pt-BR') : bVal < aVal ? -1 : 1;
                }
            });

            displayPeopleTable(filteredPeople);
        }

        // Filter people table
        function filterPeopleTable() {
            const filteredPeople = getCurrentFilteredPeople();
            displayPeopleTable(filteredPeople);
        }

        // Get currently filtered people
        function getCurrentFilteredPeople() {
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;

            return allPeople.filter(person => {
                const matchesType = !typeFilter || person.tipo === typeFilter;
                const matchesStatus = !statusFilter || person.status === statusFilter;
                return matchesType && matchesStatus;
            });
        }

        // Edit person
        function editPerson(id) {
            window.location.href = `/pages/cadastro-pessoas.html?edit=${id}`;
        }

        // View person details
        function viewPersonDetails(personId) {
            const person = allPeople.find(p => p.id === personId);
            if (!person) return;

            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Detalhes da Pessoa</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-sm-4"><strong>Nome:</strong></div>
                                <div class="col-sm-8">${person.nome}</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>Tipo:</strong></div>
                                <div class="col-sm-8"><span class="badge bg-${getTypeBadgeColor(person.tipo)}">${person.tipo}</span></div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>Telefone:</strong></div>
                                <div class="col-sm-8">${person.telefone || 'Não informado'}</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>Email:</strong></div>
                                <div class="col-sm-8">${person.email || 'Não informado'}</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>Documento:</strong></div>
                                <div class="col-sm-8">${person.documento || 'Não informado'}</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-4"><strong>Status:</strong></div>
                                <div class="col-sm-8"><span class="badge bg-${person.status === 'Ativo' ? 'success' : 'secondary'}">${person.status}</span></div>
                            </div>
                            ${person.endereco ? `
                                <div class="row mt-2">
                                    <div class="col-sm-4"><strong>Endereço:</strong></div>
                                    <div class="col-sm-8">${person.endereco}</div>
                                </div>
                            ` : ''}
                            ${person.observacoes ? `
                                <div class="row mt-2">
                                    <div class="col-sm-4"><strong>Observações:</strong></div>
                                    <div class="col-sm-8">${person.observacoes}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            <button type="button" class="btn btn-primary" onclick="editPerson(${person.id}); this.closest('.modal').remove();">
                                <i class="fas fa-edit me-1"></i>Editar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Remove modal from DOM when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        // Show/hide people consultation section
        function showPeopleConsultation() {
            const section = document.getElementById('peopleConsultationSection');
            const button = document.querySelector('button[onclick="showPeopleConsultation()"]');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.innerHTML = '<i class="fas fa-times me-1"></i>Ocultar';
                button.onclick = hidePeopleConsultation;
                
                // Load people table when showing
                loadPeopleTable();
            }
        }

        function hidePeopleConsultation() {
            const section = document.getElementById('peopleConsultationSection');
            const button = document.querySelector('button[onclick="hidePeopleConsultation()"]');
            
            section.style.display = 'none';
            button.innerHTML = '<i class="fas fa-search me-1"></i>Consultar';
            button.onclick = showPeopleConsultation;
        }
    </script>
</body>
</html>